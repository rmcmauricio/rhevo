
   {
      "$unwind":{
         "path":"$blockedLines.lines",
         "includeArrayIndex":"index"
      }
   },
   {
      "$lookup":{
         "from":"network-gbr-ELRs",
         "localField":"blockedLines.lines.lineElrInfo.from.elr.code",
         "foreignField":"elrCode",
         "as":"lineElrInfo.from.elr",
         "pipeline":[
            {
               "$project":{
                  "_id":0,
                  "refDoc":"$_id",
                  "refDocVersion":"$_version",
                  "refDocCollection":"network-gbr/elrs",
                  "code":"$elrCode"
               }
            }
         ]
      }
   },
   {
      "$lookup":{
         "from":"network-gbr-ELRs",
         "localField":"blockedLines.lines.lineElrInfo.to.elr.code",
         "foreignField":"elrCode",
         "as":"lineElrInfo.to.elr",
         "pipeline":[
            {
               "$project":{
                  "_id":0,
                  "refDoc":"$_id",
                  "refDocVersion":"$_version",
                  "refDocCollection":"network-gbr/elrs",
                  "code":"$elrCode"
               }
            }
         ]
      }
   },
   {
      "$addFields":{
         "blockedLines.lines.lineElrInfo.from.elr":"$lineElrInfo.from.elr",
         "blockedLines.lines.lineElrInfo.to.elr":"$lineElrInfo.to.elr"
      }
   },
   {
      "$group":{
         "_id":"$_id",
         "lines":{
            "$push":"$lines"
         },
         "requestId":{
            "$first":"$requestId"
         },
         "startDateTime":{
            "$first":"$startDateTime"
         },
         "endDateTime":{
            "$first":"$endDateTime"
         },
         "duration":{
            "$first":"$duration"
         },
         "dateCompletedBy":{
            "$first":"$dateCompletedBy"
         },
         "workToBeUndertaken":{
            "$first":"$workToBeUndertaken"
         },
         "workLocation":{
            "$first":"$workLocation"
         },
         "surrenderBlockageForTrains":{
            "$first":"surrenderBlockageForTrains"
         },
         "priority":{
            "$first":"$priority"
         },
         "priorityJustification":{
            "$first":"$priorityJustification"
         },
         "blockageType":{
            "$first":"$blockageType"
         },
         "possessionId":{
            "$first":"$possessionId"
         },
         "linesProtectedByPossession":{
            "$first":"$linesProtectedByPossession"
         }
      }
   }
