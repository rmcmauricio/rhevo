[
  {
    "$unwind": {
      "path": "$blockedLines.lines",
      "includeArrayIndex": "index"
    }
  },
  {
    "$lookup": {
      "from": "network-gbr-ELRs",
      "localField": "blockedLines.lines.lineElrInfo.from.elr.code",
      "foreignField": "elrCode",
      "as": "lineElrInfo.from.elr",
      "pipeline": [{
        "$project": {
          "_id": 0,
          "refDoc": "$_id",
          "refDocVersion": "$_version",
          "refDocCollection": "network-gbr/elrs",
          "code": "$elrCode"
        }
      }]
    }
  },
  {
    "$lookup": {
      "from": "network-gbr-ELRs",
      "localField": "blockedLines.lines.lineElrInfo.to.elr.code",
      "foreignField": "elrCode",
      "as": "lineElrInfo.to.elr",
      "pipeline": [{
        "$project": {
          "_id": 0,
          "refDoc": "$_id",
          "refDocVersion": "$_version",
          "refDocCollection": "network-gbr/elrs",
          "code": "$elrCode"
        }
      }]
    }
  },
  {
    "$set": {
      "blockedLines.lines.lineElrInfo.from.elr": {
        "$first": "$lineElrInfo.from.elr"
      },
      "blockedLines.lines.lineElrInfo.to.elr": {
        "$first": "$lineElrInfo.to.elr"
      },
      "blockedLines.lines.protectionStatus": "$blockedLines.lines.openOrBlocked"
    }
  },
  {
    "$group": {
      "_id": "$_id",
      "lines": {
        "$push": "$blockedLines.lines"
      }
    }
  },
  {
    "$set":
    {
      "blockedLines.lines": "$lines"
    }
  },
  {
    "$project": {
      "_id": 0,
      "lines": 0
    }
  }
]
