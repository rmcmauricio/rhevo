[
   {
      "$unwind":{
         "path":"$lines",
         "includeArrayIndex":"index"
      }
   },
   {
      "$lookup":{
         "from":"network-gbr-ELRs",
         "localField":"lines.lineElrInfo.from.elr.code",
         "foreignField":"elrCode",
         "as":"lineElrInfo.from.elr",
         "pipeline":[
            {
               "$project":{
                  "_id":0,
                  "refDoc":"$_id",
                  "refDocVersion":"$_version",
                  "refDocCollection":"network-gbr/elrs",
                  "code":"$elrCode"
               }
            }
         ]
      }
   },
   {
      "$lookup":{
         "from":"network-gbr-ELRs",
         "localField":"lines.lineElrInfo.to.elr.code",
         "foreignField":"elrCode",
         "as":"lineElrInfo.to.elr",
         "pipeline":[
            {
               "$project":{
                  "_id":0,
                  "refDoc":"$_id",
                  "refDocVersion":"$_version",
                  "refDocCollection":"network-gbr/elrs",
                  "code":"$elrCode"
               }
            }
         ]
      }
   },
   {
      "$addFields":{
         "lines.lineElrInfo.from.elr":"$lineElrInfo.from.elr",
         "lines.lineElrInfo.to.elr":{
            "$first":"$lineElrInfo.to.elr"
         }
      }
   },
   {
      "$group":{
         "_id":"$_id",
         "lines":{
            "$push":"$lines"
         }
      }
   }
]
